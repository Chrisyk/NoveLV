<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novelv - Japanese Literature Analyzer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <style>
        /* Ensure full page background coverage */
        body {
            background: var(--bg-primary);
            min-height: 100vh;
        }

        /* Page-specific styles */
        .library-section {
            margin: var(--space-lg) 0;
        }
        
        .section-header {
            margin-bottom: var(--space-lg);
        }
        
        .section-title {
            font-family: var(--font-serif);
            font-size: var(--text-2xl);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
        }
        
        .section-description {
            font-size: var(--text-base);
            color: var(--text-secondary);
        }
        
        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: var(--space-md);
        }
        
        .book-card {
            position: relative;
            overflow: hidden;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .book-cover {
            aspect-ratio: 3/4;
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-elevated));
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--text-muted);
            position: relative;
            overflow: hidden;
        }
        
        .book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: var(--radius-lg);
        }
        
        .book-cover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 45%, rgba(255,255,255,0.1) 50%, transparent 55%);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .book-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: var(--space-md);
        }
        
        .book-title {
            font-family: var(--font-japanese);
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-xs);
            line-height: 1.4;
        }
        
        .book-meta {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-sm);
            flex-wrap: wrap;
        }
        
        .meta-badge {
            background: var(--bg-elevated);
            color: var(--accent-primary);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-md);
            font-size: var(--text-xs);
            font-weight: 500;
        }
        
        .book-actions {
            display: flex;
            gap: var(--space-xs);
            margin-top: auto;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        
        .book-actions .btn {
            flex: 0 0 auto;
            white-space: nowrap;
            min-width: 0;
        }
        
        /* Enhanced button colors for book cards */
        .book-actions .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
        }
        
        .book-actions .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-600), var(--accent-secondary));
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.4);
        }
        
        .book-actions .btn-outline {
            background: transparent;
            color: var(--accent-info);
            border: 1px solid var(--accent-info);
        }
        
        .book-actions .btn-outline:hover {
            background: var(--accent-info);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        
        .book-actions .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--neutral-400);
        }
        
        .book-actions .btn-ghost:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }
        
        .book-actions .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-muted);
            border: 1px solid var(--neutral-400);
        }
        
        .book-actions .btn-secondary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* Delete button specific styling */
        .book-actions .btn-danger {
            color: var(--accent-error) !important;
            border-color: var(--accent-error);
        }
        
        .book-actions .btn-danger:hover {
            background: var(--accent-error);
            color: white !important;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
            transform: translateY(-1px);
        }
        
        .empty-library {
            text-align: center;
            padding: var(--space-2xl);
            color: var(--text-muted);
        }
        
        .empty-library-icon {
            font-size: 3rem;
            margin-bottom: var(--space-lg);
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="{{ url_for('home') }}" class="logo">
                    Novelv
                </a>
                
                <nav class="nav-links">
                    <a href="{{ url_for('home') }}" class="nav-link active">Library</a>
                    
                    <!-- Upload Icon -->
                    <div class="upload-icon-nav" id="upload-trigger">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14,2 14,8 20,8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10,9 9,9 8,9"></polyline>
                        </svg>
                        <span>Upload</span>
                    </div>
                    
                    <a href="{{ url_for('settings') }}" class="nav-link">Settings</a>
                    
                    <!-- Status Indicators -->
                    <div id="yomitan-status" class="status-indicator status-loading">
                        <div class="loading-spinner"></div>
                        <span id="yomitan-text">Yomitan</span>
                    </div>
                    
                    <div id="anki-status" class="status-indicator status-loading">
                        <div class="loading-spinner"></div>
                        <span id="anki-text">Anki</span>
                    </div>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'error' if category == 'error' else 'success' if category == 'success' else 'info' }} animate-slide-in">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        <!-- Hidden Upload Form -->
        <form id="upload-form" method="post" enctype="multipart/form-data" action="{{ url_for('upload_file') }}" style="display: none;">
            <input type="file" name="file" accept=".txt,.md,.epub" id="file-input" multiple>
        </form>

        <!-- Library Section -->
        <section class="library-section">
            <div class="section-header">
                <h2 class="section-title">üìö Your Library</h2>
                <p class="section-description">Japanese novels ready for vocabulary analysis</p>
            </div>

            {% if novels %}
                <div class="library-grid">
                    {% for novel in novels %}
                        <div class="card book-card animate-slide-in">
                            <div class="book-cover">
                                {% if novel.cover_image %}
                                    <img src="{{ url_for('serve_cover', filename=novel.cover_image) }}" alt="{{ novel.display_name }} cover">
                                {% else %}
                                    üìñ
                                {% endif %}
                            </div>
                            
                            <div class="card-body book-info">
                                <h3 class="book-title">{{ novel.display_name }}</h3>
                                
                                <div class="book-meta">
                                    <span class="meta-badge">{{ "%.1f KB"|format(novel.size / 1024) }}</span>
                                    <span class="meta-badge">{{ novel.modified.strftime('%Y-%m-%d') }}</span>
                                </div>
                                
                                <div class="book-actions">
                                    {% if has_caches %}
                                        <a href="{{ url_for('analyze_novel', filename=novel.filename) }}" class="btn btn-primary btn-sm">
                                            üìä Analyze
                                        </a>
                                    {% else %}
                                        <button class="btn btn-secondary btn-sm" disabled>
                                            üìä Need Vocab Setup
                                        </button>
                                    {% endif %}
                                    
                                    <a href="{{ url_for('file_records', filename=novel.filename) }}" class="btn btn-ghost btn-sm">
                                        üìã Records
                                    </a>
                                    
                                    <button onclick="deleteFile('{{ novel.filename }}')" class="btn btn-ghost btn-sm btn-danger">
                                        üóëÔ∏è Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-library">
                    <div class="empty-library-icon">üìö</div>
                    <h3>Your library is empty</h3>
                    <p>Upload your first Japanese novel to get started with vocabulary analysis</p>
                </div>
            {% endif %}
        </section>
    </main>

    <!-- JavaScript -->
    <script>
        // Delete file confirmation
        function deleteFile(filename) {
            if (confirm(`Are you sure you want to delete "${filename}"? This action cannot be undone.`)) {
                window.location.href = `/delete/${filename}`;
            }
        }

        // Upload functionality
        document.getElementById('upload-trigger').addEventListener('click', function() {
            document.getElementById('file-input').click();
        });

        // Handle file selection
        document.getElementById('file-input').addEventListener('change', function(event) {
            const form = document.getElementById('upload-form');
            if (event.target.files.length > 0) {
                form.submit();
            }
        });

        // Yomitan status check
        async function checkYomitanStatus() {
            const statusEl = document.getElementById('yomitan-status');
            
            try {
                const response = await fetch('/health/yomitan');
                const data = await response.json();
                
                if (response.ok && data.healthy) {
                    statusEl.className = 'status-indicator status-healthy';
                    statusEl.innerHTML = '<span>‚úÖ</span><span>Yomitan</span>';
                } else {
                    statusEl.className = 'status-indicator status-unhealthy';
                    statusEl.innerHTML = '<span>‚ùå</span><span>Yomitan</span>';
                }
            } catch (error) {
                statusEl.className = 'status-indicator status-unhealthy';
                statusEl.innerHTML = '<span>‚ùå</span><span>Yomitan</span>';
            }
        }

        // Anki status check
        async function checkAnkiStatus() {
            const statusEl = document.getElementById('anki-status');
            
            try {
                const response = await fetch('/health/anki');
                const data = await response.json();
                
                if (response.ok && data.healthy) {
                    statusEl.className = 'status-indicator status-healthy';
                    statusEl.innerHTML = '<span>‚úÖ</span><span>Anki</span>';
                } else {
                    statusEl.className = 'status-indicator status-unhealthy';
                    statusEl.innerHTML = '<span>‚ùå</span><span>Anki</span>';
                }
            } catch (error) {
                statusEl.className = 'status-indicator status-unhealthy';
                statusEl.innerHTML = '<span>‚ùå</span><span>Anki</span>';
            }
        }

        // Check status on load
        document.addEventListener('DOMContentLoaded', function() {
            checkYomitanStatus();
            checkAnkiStatus();
        });
        
        // Refresh status every 30 seconds
        setInterval(function() {
            checkYomitanStatus();
            checkAnkiStatus();
        }, 30000);
    </script>
</body>
</html>